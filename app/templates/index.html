{% extends "base.html" %}

{% block title %}Popular Movies{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Popular Movies</h1>

    <!-- üîé –ü–æ—à—É–∫ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="search-input" class="form-control" placeholder="Search movie by title...">
        </div>
        <div class="col-md-2">
            <button id="search-button" class="btn btn-primary w-100">Search</button>
        </div>
    </div>

    <!-- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è -->
    <div class="row mb-4">
        <div class="col-md-4">
            <select id="sort-select" class="form-select">
                <option value="popularity" selected>Sort by Popularity</option>
                <option value="release">Sort by Release Date</option>
                <option value="imdb_score">Sort by IMDb Score</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="sort-order" id="descending" value="desc" checked>
                <label class="form-check-label" for="descending">
                    Descending
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="sort-order" id="ascending" value="asc">
                <label class="form-check-label" for="ascending">
                    Ascending
                </label>
            </div>
        </div>
    </div>

    <div id="movie-list" class="list-group">
        <!-- –°—é–¥–∏ –±—É–¥–µ –¥–æ–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏—Å—å —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <div class="d-grid mt-4">
        <button id="load-more" class="btn btn-primary">Show More</button>
    </div>
</div>

<script>
const originalMovies = JSON.parse('{{ movies_json|safe }}');
let movies = [...originalMovies];
let filteredMovies = [...originalMovies];
let currentIndex = 0;
const moviesPerPage = 8;

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ñ—ñ–ª—å–º—ñ–≤
function renderMovies(reset = false) {
    const movieList = document.getElementById('movie-list');
    if (reset) {
        movieList.innerHTML = '';
        currentIndex = 0;
    }
    for (let i = currentIndex; i < currentIndex + moviesPerPage && i < filteredMovies.length; i++) {
        const a = document.createElement('a');
        a.className = 'list-group-item list-group-item-action';
        a.href = `/movie/${filteredMovies[i].id}`;
        a.innerHTML = `
            <h5 class="mb-1">${filteredMovies[i].title}</h5>
            <small>Release: ${filteredMovies[i].release || "Unknown"}, IMDb Score: ${filteredMovies[i].imdb_score || "N/A"}</small>
        `;
        movieList.appendChild(a);
    }
    currentIndex += moviesPerPage;
    if (currentIndex >= filteredMovies.length) {
        document.getElementById('load-more').style.display = 'none';
    } else {
        document.getElementById('load-more').style.display = 'block';
    }
}

// –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–ø—Ä—è–º —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
function getSortOrder() {
    return document.querySelector('input[name="sort-order"]:checked').value;
}

// –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –æ–±—Ä–∞–Ω–∏–º –ø–æ–ª–µ–º —ñ –Ω–∞–ø—Ä—è–º–æ–º
function sortMovies() {
    const sortBy = document.getElementById('sort-select').value;
    const order = getSortOrder();
    filteredMovies.sort((a, b) => {
        let aVal = a[sortBy] || '';
        let bVal = b[sortBy] || '';
        if (sortBy === 'release') {
            return order === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return order === 'asc' ? aVal - bVal : bVal - aVal;
        }
    });
    renderMovies(true);
}

// –ü–æ—à—É–∫ —Ñ—ñ–ª—å–º—ñ–≤
function searchMovies() {
    const query = document.getElementById('search-input').value.trim().toLowerCase();
    filteredMovies = movies.filter(movie => movie.title.toLowerCase().includes(query));
    sortMovies(); // –ü—ñ—Å–ª—è –ø–æ—à—É–∫—É —Ç–∞–∫–æ–∂ –≤—ñ–¥—Å–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑–∞ –æ–±—Ä–∞–Ω–∏–º –ø—Ä–∞–≤–∏–ª–æ–º
}

// –ü–æ–¥—ñ—ó
document.getElementById('load-more')?.addEventListener('click', function() {
    renderMovies(false);
});

document.getElementById('sort-select').addEventListener('change', sortMovies);
document.querySelectorAll('input[name="sort-order"]').forEach(radio => {
    radio.addEventListener('change', sortMovies);
});
document.getElementById('search-button').addEventListener('click', searchMovies);
document.getElementById('search-input').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        searchMovies();
    }
});

// –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
document.addEventListener('DOMContentLoaded', function() {
    renderMovies(false);
});
</script>

{% endblock %}
